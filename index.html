<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StreamDL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #000000;
    --surface: #0a0a0a;
    --surface-2: #111111;
    --border: #1f1f1f;
    --border-hover: #333;
    --text: #ededed;
    --text-muted: #737373;
    --text-dim: #404040;
    --accent: #ffffff;
    --green: #4ade80;
    --red: #f87171;
    --yellow: #facc15;
    --blue: #60a5fa;
  }

  html, body {
    min-height: 100vh;
    background: var(--bg);
    color: var(--text);
    font-family: 'Geist', -apple-system, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  /* Subtle grid bg */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 48px 48px;
    opacity: 0.3;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(255,255,255,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 680px;
    margin: 0 auto;
    padding: 80px 24px 120px;
  }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 64px;
    animation: fadeUp 0.6s ease both;
  }

  .logo {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    text-decoration: none;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    background: var(--accent);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-icon svg {
    width: 16px;
    height: 16px;
    fill: #000;
  }

  .logo-text {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.02em;
  }

  .header h1 {
    font-size: clamp(28px, 5vw, 40px);
    font-weight: 600;
    letter-spacing: -0.04em;
    color: var(--text);
    margin-bottom: 12px;
    line-height: 1.1;
  }

  .header p {
    color: var(--text-muted);
    font-size: 15px;
    max-width: 380px;
    margin: 0 auto;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 12px;
    animation: fadeUp 0.6s ease both;
    transition: border-color 0.2s;
  }

  .card:hover { border-color: var(--border-hover); }

  .card-title {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  /* Form elements */
  .field {
    margin-bottom: 16px;
  }

  label {
    display: block;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 6px;
    letter-spacing: 0.01em;
  }

  input, select {
    width: 100%;
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-family: 'Geist Mono', monospace;
    font-size: 14px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
    -webkit-appearance: none;
  }

  input:focus, select:focus {
    border-color: #555;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.04);
  }

  input::placeholder { color: var(--text-dim); }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23737373' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
  }

  .row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  /* Type toggle */
  .type-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 20px;
  }

  .type-btn {
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Geist', sans-serif;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .type-btn:hover { border-color: var(--border-hover); color: var(--text); }

  .type-btn.active {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(255,255,255,0.03);
  }

  /* Button */
  .btn {
    width: 100%;
    padding: 11px 20px;
    border-radius: 8px;
    border: none;
    font-family: 'Geist', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--accent);
    color: #000;
  }

  .btn-primary:hover { background: #e0e0e0; transform: translateY(-1px); }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: var(--surface-2);
    color: var(--text);
    border: 1px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--border-hover); background: #161616; }

  /* Sources list */
  .sources-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .source-item {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 12px;
    position: relative;
    overflow: hidden;
  }

  .source-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, rgba(255,255,255,0.01), transparent);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .source-item:hover { border-color: var(--border-hover); }
  .source-item:hover::before { opacity: 1; }
  .source-item.selected { border-color: var(--accent); background: rgba(255,255,255,0.02); }
  .source-item.testing { opacity: 0.7; cursor: wait; }
  .source-item.dead { opacity: 0.35; }

  .source-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    position: relative;
  }

  .source-status.checking {
    background: var(--yellow);
    animation: pulse 1s ease infinite;
  }

  .source-status.ok { background: var(--green); }
  .source-status.ok::after {
    content: '';
    position: absolute;
    inset: -2px;
    border-radius: 50%;
    background: var(--green);
    opacity: 0.3;
    animation: ping 1.5s ease infinite;
  }

  .source-status.fail { background: var(--red); }
  .source-status.unknown { background: var(--text-dim); }

  .source-info { flex: 1; min-width: 0; }

  .source-provider {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 2px;
  }

  .source-meta {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    padding: 1px 7px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
    font-family: 'Geist Mono', monospace;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
  }

  .badge.hls { color: #60a5fa; border-color: rgba(96,165,250,0.2); background: rgba(96,165,250,0.05); }
  .badge.mp4 { color: var(--green); border-color: rgba(74,222,128,0.2); background: rgba(74,222,128,0.05); }
  .badge.q1080 { color: var(--yellow); border-color: rgba(250,204,21,0.2); background: rgba(250,204,21,0.05); }

  .source-latency {
    margin-left: auto;
    font-family: 'Geist Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
  }

  /* Progress */
  .progress-wrap {
    margin-top: 16px;
  }

  .progress-bar {
    height: 3px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .progress-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 1.5s ease infinite;
  }

  .progress-text {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'Geist Mono', monospace;
  }

  /* Log */
  .log {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    font-family: 'Geist Mono', monospace;
    font-size: 12px;
    color: var(--text-muted);
    max-height: 120px;
    overflow-y: auto;
    margin-top: 12px;
  }

  .log-line { margin-bottom: 2px; }
  .log-line.ok { color: var(--green); }
  .log-line.err { color: var(--red); }
  .log-line.info { color: var(--blue); }

  /* Download btn */
  .btn-download {
    background: var(--green);
    color: #000;
    font-weight: 600;
    margin-top: 16px;
  }

  .btn-download:hover { background: #6ee79e; }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  /* Spinner */
  .spinner {
    width: 14px;
    height: 14px;
    border: 2px solid rgba(0,0,0,0.3);
    border-top-color: #000;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  .spinner-white {
    border-color: rgba(255,255,255,0.2);
    border-top-color: var(--text);
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--text);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    z-index: 100;
    animation: slideIn 0.3s ease;
    max-width: 320px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .toast.success { border-color: rgba(74,222,128,0.3); }
  .toast.error { border-color: rgba(248,113,113,0.3); }

  /* Animations */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  @keyframes ping {
    0% { transform: scale(1); opacity: 0.4; }
    100% { transform: scale(2.5); opacity: 0; }
  }

  @keyframes shimmer {
    from { transform: translateX(-100%); }
    to { transform: translateX(100%); }
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .card:nth-child(2) { animation-delay: 0.05s; }
  .card:nth-child(3) { animation-delay: 0.1s; }

  #sources-section, #convert-section { display: none; }

  .section-label {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-dim);
    margin-bottom: 8px;
    padding-left: 2px;
  }

  .info-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .info-row strong { color: var(--text); font-weight: 500; }

  .selected-source-info {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 8px;
    padding: 12px 14px;
    margin-bottom: 16px;
    font-size: 13px;
  }

  .sr { display: flex; justify-content: space-between; align-items: center; }
  .sr span { color: var(--text-muted); font-size: 12px; }
  .sr strong { color: var(--text); font-family: 'Geist Mono', monospace; font-size: 12px; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 2.5A1.5 1.5 0 014.5 1h7A1.5 1.5 0 0113 2.5v11a.5.5 0 01-.777.416L8 11.101l-4.223 2.815A.5.5 0 013 13.5v-11z"/>
        </svg>
      </div>
      <span class="logo-text">StreamDL</span>
    </div>
    <h1>Download any stream,<br>instantly.</h1>
    <p>Enter a TMDB ID, pick a source, and convert to MP4.</p>
  </div>

  <!-- Step 1: Search -->
  <div class="card" id="search-card">
    <div class="card-title">01 — Content</div>
    
    <div class="type-toggle">
      <button class="type-btn active" id="btn-movie" onclick="setType('movie')">
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 2A1.5 1.5 0 000 3.5v9A1.5 1.5 0 001.5 14h13a1.5 1.5 0 001.5-1.5v-9A1.5 1.5 0 0014.5 2h-13zm1 1h11l-1.5 2H4L2.5 3z"/></svg>
        Movie
      </button>
      <button class="type-btn" id="btn-tv" onclick="setType('tv')">
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 13.5A.5.5 0 013 13h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zM13.991 3l.024.001a1.46 1.46 0 01.538.143.757.757 0 01.302.254c.067.1.145.277.145.602v8c0 .325-.078.502-.145.602a.757.757 0 01-.302.254 1.464 1.464 0 01-.538.143L14 13H2l-.024-.001a1.464 1.464 0 01-.538-.143.758.758 0 01-.302-.254C1.078 12.502 1 12.325 1 12V4c0-.325.078-.502.145-.602a.757.757 0 01.302-.254A1.46 1.46 0 012 3h12z"/></svg>
        TV Show
      </button>
    </div>

    <div class="field">
      <label>TMDB ID</label>
      <input type="number" id="tmdb-id" placeholder="e.g. 671" />
    </div>

    <div id="tv-fields" style="display:none;">
      <div class="row-2">
        <div class="field">
          <label>Season</label>
          <input type="number" id="season" placeholder="1" min="1" value="1" />
        </div>
        <div class="field">
          <label>Episode</label>
          <input type="number" id="episode" placeholder="1" min="1" value="1" />
        </div>
      </div>
    </div>

    <button class="btn btn-primary" id="fetch-btn" onclick="fetchSources()">
      <span id="fetch-btn-text">Fetch Sources</span>
    </button>
  </div>

  <!-- Step 2: Sources -->
  <div id="sources-section">
    <div class="section-label">02 — Pick a Source</div>
    <div class="card" style="animation-delay:0.05s">
      <div id="sources-testing-header" class="info-row" style="margin-bottom:14px">
        <div class="spinner spinner-white" style="width:12px;height:12px;border-width:1.5px"></div>
        <span>Testing <strong id="test-count">0</strong> sources...</span>
      </div>
      <div class="sources-grid" id="sources-list"></div>
    </div>
    <button class="btn btn-secondary" style="margin-top:8px; font-size:13px; height:40px" onclick="proceedToConvert()" id="pick-btn" disabled>
      Convert Selected Source →
    </button>
  </div>

  <!-- Step 3: Convert -->
  <div id="convert-section">
    <div class="section-label">03 — Convert & Download</div>
    <div class="card" style="animation-delay:0.1s">
      <div class="selected-source-info" id="selected-info"></div>

      <div class="field">
        <label>Output Filename</label>
        <input type="text" id="filename" placeholder="movie_name" />
      </div>

      <button class="btn btn-primary" id="convert-btn" onclick="startConvert()">
        <span id="convert-btn-text">Convert to MP4</span>
      </button>

      <div class="progress-wrap" id="progress-wrap" style="display:none">
        <div class="divider"></div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width:0%"></div>
        </div>
        <div class="progress-text">
          <span id="progress-label">Starting...</span>
          <span id="progress-pct">0%</span>
        </div>
        <div class="log" id="log"></div>
        <button class="btn btn-download" id="dl-btn" style="display:none" onclick="triggerDownload()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 01.5.5v2.5a1 1 0 001 1h12a1 1 0 001-1v-2.5a.5.5 0 011 0v2.5a2 2 0 01-2 2H2a2 2 0 01-2-2v-2.5a.5.5 0 01.5-.5z"/><path d="M7.646 11.854a.5.5 0 00.708 0l3-3a.5.5 0 00-.708-.708L8.5 10.293V1.5a.5.5 0 00-1 0v8.793L5.354 8.146a.5.5 0 10-.708.708l3 3z"/></svg>
          Download MP4
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const CINEPRO = 'http://localhost:3002';
const CONVERT_API = 'http://localhost:5000';

let currentType = 'movie';
let sources = [];
let selectedSource = null;
let downloadId = null;

/* =========================
   FETCH SOURCES (3002)
========================= */
async function fetchSources() {
  const id = document.getElementById('tmdb-id').value.trim();
  if (!id) return;

  let url;

  if (currentType === 'movie') {
    url = `${CINEPRO}/v1/movies/${id}`;
  } else {
    const season = document.getElementById('season').value || 1;
    const episode = document.getElementById('episode').value || 1;
    url = `${CINEPRO}/v1/tv/${id}/seasons/${season}/episodes/${episode}`;
  }

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('CinePro error');

    const data = await res.json();
    if (!data.sources || !data.sources.length)
      throw new Error('No sources found');

    sources = data.sources;
    renderSources(sources);
    testAllSources(sources);

  } catch (err) {
    console.error(err);
  }
}

/* =========================
   RENDER
========================= */
function renderSources(list) {
  const el = document.getElementById('sources-list');
  el.innerHTML = '';

  list.forEach((s, i) => {
    const item = document.createElement('div');
    item.className = 'source-item testing';
    item.id = `source-${i}`;
    item.onclick = () => selectSource(i);

    item.innerHTML = `
      <div class="source-status checking" id="status-${i}"></div>
      <div class="source-provider">${s.provider?.name || 'Unknown'}</div>
      <div>${s.quality || 'Unknown'} • ${(s.type || '').toUpperCase()}</div>
      <div id="latency-${i}">—</div>
    `;

    el.appendChild(item);
  });
}

/* =========================
   TEST SOURCES (5000)
========================= */
async function testAllSources(list) {
  await Promise.all(list.map(async (s, i) => {
    try {
      const res = await fetch(`${CONVERT_API}/api/test-source`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: s.url,
          headers: s.headers || {}
        })
      });

      const data = await res.json();

      const status = document.getElementById(`status-${i}`);
      const latency = document.getElementById(`latency-${i}`);
      const item = document.getElementById(`source-${i}`);

      if (data.ok) {
        status.className = 'source-status ok';
        latency.textContent = data.latency + 'ms';
        item.classList.remove('testing');
      } else {
        status.className = 'source-status fail';
        latency.textContent = 'dead';
        item.classList.add('dead');
      }
    } catch {
      document.getElementById(`source-${i}`).classList.add('dead');
    }
  }));
}

/* =========================
   SELECT
========================= */
function selectSource(i) {
  selectedSource = i;
  document.querySelectorAll('.source-item')
    .forEach((el, j) => el.classList.toggle('selected', j === i));
}

/* =========================
   CONVERT (5000)
========================= */
async function startConvert() {
  if (selectedSource === null) return;

  const s = sources[selectedSource];
  const filename = document.getElementById('filename').value || 'download';

  try {
    const resp = await fetch(`${CONVERT_API}/api/convert-progress`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        url: s.url,
        headers: s.headers || {},
        filename
      })
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const ev = JSON.parse(line.slice(6));
          handleProgress(ev);
        }
      }
    }
  } catch (err) {
    console.error('Convert failed:', err);
  }
}

/* =========================
   PROGRESS HANDLER
========================= */
function handleProgress(ev) {
  if (ev.type === 'progress') {
    document.getElementById('progress-fill').style.width =
      parseFloat(ev.pct) + '%';
  }

  if (ev.type === 'done') {
    downloadId = ev.downloadId;
    document.getElementById('dl-btn').style.display = 'flex';
  }
}

/* =========================
   DOWNLOAD (5000)
========================= */
function triggerDownload() {
  if (!downloadId) return;

  const a = document.createElement('a');
  a.href = `${CONVERT_API}/api/download/${downloadId}`;
  a.download =
    (document.getElementById('filename').value || 'download') + '.mp4';

  document.body.appendChild(a);
  a.click();
  a.remove();
}
</script>
</body>
</html>
